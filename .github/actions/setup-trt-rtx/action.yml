name: 'Setup TensorRT-RTX'
description: 'Download, cache and setup TensorRT-RTX SDK for specific CUDA versions'
inputs:
  cuda-version:
    description: 'CUDA Version (e.g., 12.9, 13.1)'
    required: true
  trt-version:
    description: 'TensorRT-RTX Version'
    required: false
    default: '1.3.0.35'

runs:
  using: "composite"
  steps:
    - name: Construct Filenames
      shell: bash
      id: meta
      run: |
        FILENAME="TensorRT-RTX-${{ inputs.trt-version }}-Linux-x86_64-cuda-${{ inputs.cuda-version }}-Release-external.tar.gz"
        URL="https://developer.nvidia.com/downloads/trt/rtx_sdk/secure/1.3/$FILENAME"
        
        echo "filename=$FILENAME" >> $GITHUB_OUTPUT
        echo "url=$URL" >> $GITHUB_OUTPUT
        # 统一安装路径
        INSTALL_PATH="${{ github.workspace }}/tensorrt-rtx-sdk"
        echo "install_path=${INSTALL_PATH}" >> $GITHUB_OUTPUT

    - name: Cache TensorRT-RTX
      id: cache-trt
      uses: actions/cache@v4
      with:
        path: ${{ steps.meta.outputs.install_path }}
        # 缓存 Key
        key: trt-rtx-v2-${{ runner.os }}-${{ inputs.trt-version }}-cuda-${{ inputs.cuda-version }}

    - name: Download and Extract
      if: steps.cache-trt.outputs.cache-hit != 'true'
      shell: bash
      run: |
        echo "Cache miss. Downloading from ${{ steps.meta.outputs.url }}..."
        
        # 1. 确保目标目录不存在 (防止冲突)
        rm -rf "${{ steps.meta.outputs.install_path }}"
        
        # 2. 下载
        wget -q --no-check-certificate "${{ steps.meta.outputs.url }}" -O trt_rtx.tar.gz
        
        # 3. 解压到临时目录
        mkdir -p temp_extract
        tar -xf trt_rtx.tar.gz -C temp_extract
        
        # 4. 查找解压出的真实目录名 (通常是 TensorRT-RTX-1.3.0.35)
        # 使用 find 查找 temp_extract 下的第一个子目录
        EXTRACTED_DIR=$(find temp_extract -maxdepth 1 -mindepth 1 -type d | head -n 1)
        
        echo "Found extracted directory: $EXTRACTED_DIR"
        
        # 5. 移动 (重命名) 到最终目标路径
        if [ -d "$EXTRACTED_DIR" ]; then
          mv "$EXTRACTED_DIR" "${{ steps.meta.outputs.install_path }}"
          echo "✅ Moved to ${{ steps.meta.outputs.install_path }}"
        else
          echo "❌ Error: Could not find extracted directory in temp_extract"
          ls -R temp_extract
          exit 1
        fi
        
        # 6. 清理
        rm -rf temp_extract trt_rtx.tar.gz

    - name: Export Environment Variables
      shell: bash
      run: |
        echo "TRT_RTX_HOME=${{ steps.meta.outputs.install_path }}" >> $GITHUB_ENV