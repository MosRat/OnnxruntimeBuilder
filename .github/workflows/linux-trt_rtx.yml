name: linux-trt_rtx

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    # 保持使用 Ubuntu 20.04 容器，为了 glibc 兼容性
    container:
      image: ubuntu:20.04

    strategy:
      fail-fast: false
      matrix:
        cuda_ver: ["12.9", "13.1"]
        python_ver: ["3.11"]

    env:
      DEBIAN_FRONTEND: noninteractive

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. 基础环境安装
      - name: Install Base Dependencies
        run: |
          apt-get update
          apt-get install -y wget curl git build-essential ca-certificates tar unzip zip jq sudo libarchive-tools ninja-build lsb-release gnupg software-properties-common pkg-config zlib1g-dev libssl-dev libffi-dev openssl
          # libarchive-tools 包含 bsdtar 等工具，有时解压需要

      # 2. 获取 ORT 最新 Release Tag (修正点 1)
      - name: Get Latest ORT Tag
        id: get_tag
        run: |
          # 调用 GitHub API 获取最新 Release 的 tag_name
          LATEST_TAG=$(curl -sL https://api.github.com/repos/microsoft/onnxruntime/releases/latest | jq -r ".tag_name")
          echo "Latest tag detected: $LATEST_TAG"
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      # 3. Checkout ORT 代码 (使用最新 Tag)
      - name: Checkout ONNX Runtime
        uses: actions/checkout@v4
        with:
          repository: microsoft/onnxruntime
          path: onnxruntime
          ref: ${{ steps.get_tag.outputs.tag }} # 使用刚才获取的 Tag
          submodules: recursive

      # 4. 初始化 CUDA (使用 Jimver Action 自动缓存)
      - name: Setup CUDA
        uses: Jimver/cuda-toolkit@v0.2.30
        id: cuda-toolkit
        with:
          cuda: ${{ matrix.cuda_ver }}.0
          method: ${{ contains(matrix.cuda_ver, '13') && 'local' || 'network' }}
          # 安装 nvcc 和编译必要的库
        #   sub-packages: '["nvcc", "cudart", "visual_studio_integration"]'

      # 5. 初始化 TensorRT-RTX (使用我们定义的本地 Action)
      # 请确保 .github/actions/setup-trt-rtx/action.yml 文件存在 (见上一条回复)
      - name: Setup TensorRT-RTX
        uses: ./.github/actions/setup-trt-rtx
        with:
          cuda-version: ${{ matrix.cuda_ver }}
          # 如果你要针对 12.9 使用特定版本 TRT，可以在这里控制 inputs

      # 6. 安装 Python (用于编译 Wheel)
      - name: Install Python ${{ matrix.python_ver }}
        run: |
          # 1. 再次确保 update，防止之前的缓存过期
          apt-get update -y
          
          # 2. 安装 PPA 管理工具 (如果 Base Dependencies 没装全的话)
          apt-get install -y software-properties-common gpg-agent curl
          
          # 3. 添加 Deadsnakes PPA (专门提供各版本 Python)
          add-apt-repository -y ppa:deadsnakes/ppa
          
          # 4. [关键] 必须再次 Update 才能看到新 repo 里的包！
          apt-get update -y
          
          # 5. 安装 Python 及其开发头文件 (注意: deadsnakes 不包含 pip)
          # python3.11-distutils 在新版中通常包含在核心或 venv 中，或者是 python3-distutils
          # 这里安装 venv 和 dev 通常就够了
          apt-get install -y \
            python${{ matrix.python_ver }} \
            python${{ matrix.python_ver }}-dev \
            python${{ matrix.python_ver }}-venv \
            python${{ matrix.python_ver }}-distutils || echo "distutils included or not found"
          
          # 6. [关键] 手动安装 pip (这是最稳的方法，避开 apt 的旧版 pip)
          curl -sS https://bootstrap.pypa.io/get-pip.py | python${{ matrix.python_ver }}
          
          # 7. 建立软链接 (可选，方便直接敲 python)
          update-alternatives --install /usr/bin/python3 python3 /usr/bin/python${{ matrix.python_ver }} 1
          update-alternatives --install /usr/bin/python python /usr/bin/python${{ matrix.python_ver }} 1
          
          # 8. 验证
          python --version
          pip --version

      # 7. 安装 CMake (Ubuntu 20.04 自带太老)
      - name: Install CMake
        uses: jwlawson/actions-setup-cmake@v2.0
        with:
          cmake-version: '3.29.0'

      # 8. 执行构建
      - name: Build ORT
        working-directory: ${{ github.workspace }}
        run: |
          chmod +x build-onnxruntime-linux-trt_rtx.sh
          ./build-onnxruntime-linux-trt_rtx.sh
        env:
          ORT_PATH: onnxruntime
          # TRT_RTX_HOME 由 setup-trt-rtx Action 注入
          CUDA_VERSION: ${{ matrix.cuda_ver }}
          PYTHON_EXEC: python${{ matrix.python_ver }}

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: onnxruntime-linux-cuda${{ matrix.cuda_ver }}-rtx
          path: |
            ${{ github.workspace }}/output/*.7z
            ${{ github.workspace }}/output/*.whl